---
sidebar_position: 1
---

# 用 DSPy 完成 8 个步骤

在解决新任务时，很好地使用 DSPy 就是在使用 LM 进行良好的机器学习。

这意味着这是一个迭代的过程。您会做一些初始选择，这些选择可能不是最优的，然后逐步进行改进。

正如我们下面所讨论的，您将定义您的任务和要最大化的指标，并准备一些示例输入 —— 通常没有标签（或者仅在最终输出需要标签的情况下）。然后，通过选择内置层[(`modules`)](https://dspy-docs.vercel.app/docs/building-blocks/modules)来构建您的管道，为每个层指定[`signature`（输入/输出规范）](https://dspy-docs.vercel.app/docs/building-blocks/signatures)，然后在您的 Python 代码中自由调用您的模块。最后，您使用 DSPy [`optimizer`](https://dspy-docs.vercel.app/docs/building-blocks/optimizers)将您的代码编译成高质量的指令，自动的少样本示例，或者用于您的 LM 的更新权重。


## 1) 定义您的任务

如果您没有定义您要解决的问题，就无法很好地使用 DSPy。

**预期的输入/输出行为：** 您是想要在您的数据上构建一个聊天机器人吗？一个代码助手？一个从论文中提取信息的系统？或者一个翻译系统？或者一个用于从搜索结果中突出显示片段的系统？或者一个用于总结某个主题信息的系统，带有引用？

通常，想出程序的输入和输出的 3-4 个示例是很有用的（例如，问题及其答案，或者主题及其摘要）。

如果您需要帮助思考您的任务，我们最近为社区创建了一个[Discord 服务器](https://discord.gg/VzS6RHHK6F)。

**质量和成本规格：** 您可能没有无限的预算。您的最终系统不能太昂贵，而且对用户的响应时间可能也应该足够快。

把这看作一个猜测您想使用什么样的语言模型的机会。也许是 GPT-3.5？或者一个小型的开放模型，比如 Mistral-7B 或 Llama2-13B-chat？或者 Mixtral？或者也许您真的需要 GPT-4-turbo？或者也许您的资源非常有限，您希望最终的 LM 是 T5-base。

## 2) 定义您的管道

您的 DSPy 程序应该做什么？它只能是一个简单的思维链步骤吗？或者您需要 LM 使用检索？或者其他工具，比如计算器或日历 API？

解决您的问题是否有一个典型的工作流程，需要在多个明确定义的步骤中解决？或者您是否希望为您的任务使用完全开放式的 LM（或者使用代理进行开放式工具使用）？

考虑这个空间，但始终从简单开始。几乎每个任务可能都应该从一个简单的[dspy.ChainofThought](https://dspy-docs.vercel.app/api/modules/ChainOfThought)模块开始，然后随着进行逐步增加复杂性。

然后编写您的（初始）DSPy 程序。再次强调：从简单开始，让接下来的几个步骤指导您将要添加的任何复杂性。
## 3) 探索几个示例。

到这一步，你可能已经有了一些你想要解决的任务示例。

将它们通过你的流程。考虑在这一点上使用一个大而强大的语言模型，或者几个不同的语言模型，只是为了了解可能性。（DSPy 将使得在这些语言模型之间轻松切换 - [语言模型指南](https://dspy-docs.vercel.app/docs/building-blocks/language_models)。）

在这一点上，你仍然是零-shot 使用你的流程，所以它离完美还有很远。DSPy 将帮助你优化下面 LM 调用的指令、少量示例，甚至权重，但了解零-shot 使用中出现问题的地方将大有裨益。

记录你尝试的有趣（易和难）的示例：即使你没有标签，简单地跟踪你尝试过的输入对于下面的 DSPy 优化器也是有用的。

## 4) 定义你的数据。

现在是时候更正式地声明你的训练和验证数据，以供 DSPy 评估和优化 - [数据指南](https://dspy-docs.vercel.app/docs/building-blocks/data)。

你可以用尽量少的 10 个示例来有效地使用 DSPy 优化器，但有 50-100 个示例（或者更好的是 300-500 个示例）会大有裨益。

你如何获得这些示例呢？如果你的任务非常不寻常，请投入精力手工准备约 10 个示例。通常情况下，根据下面的度量标准，你只需要输入而不是标签，所以并不难。

然而，你的任务很可能并不是那么独特。你几乎总是可以在 HuggingFace 数据集或其他形式的数据上找到相邻的数据集，可以在这里利用。

如果有数据的许可证足够宽松，我们建议你使用它们。否则，你也可以开始使用/部署/演示你的系统，并以这种方式收集一些初始数据。

## 5) 定义你的度量标准。

什么使得你系统的输出好坏？投资于定义度量标准，并随着时间逐步改进它们。如果你无法定义，就很难持续改进。

度量标准只是一个函数，它将从你的数据中获取示例，获取你系统的输出，并返回一个量化输出有多好的分数 - [度量标准指南](https://dspy-docs.vercel.app/docs/building-blocks/metrics)。

对于简单的任务，这可能只是“准确率”或“精确匹配”或“F1 分数”。这可能适用于简单的分类或短形式问答任务。

然而，对于大多数应用，你的系统将输出长形式输出。在这种情况下，你的度量标准可能是一个较小的 DSPy 程序，检查输出的多个属性（很可能使用来自语言模型的 AI 反馈）。
开始时很难一次就做对，但你应该从简单的事情开始并进行迭代。（如果你的度量标准本身是一个 DSPy 程序，注意迭代的一种最有效的方法是编译（优化）度量标准本身。这通常很容易，因为度量标准的输出通常是一个简单的值（例如，5分中的得分），因此度量标准的度量标准易于定义，并通过收集一些示例进行优化。）

## 6) 收集初步的“零-shot”评估。

现在你有了一些数据和一个度量标准，在任何优化器运行之前，在你的流程上运行评估。

查看输出和度量分数。这可能会帮助你发现任何主要问题，并为下一步定义一个基准。

## 7) 使用 DSPy 优化器进行编译。

给定一些数据和一个度量标准，我们现在可以优化你构建的程序 - [优化器指南](https://dspy-docs.vercel.app/docs/building-blocks/optimizers)。

DSPy 包含许多执行不同任务的优化器。记住：DSPy 优化器将创建每个步骤的示例，制定指令和/或更新 LM 权重。一般来说，你不需要为你的流程步骤设置标签，但你的数据示例需要具有输入值和度量标准所需的任何标签（例如，如果你的度量标准是无参考的，则不需要标签，但在大多数情况下，最终输出需要标签）。

以下是开始的一般指导：

* 如果你的数据非常少，例如你的任务有 10 个示例，使用 [`BootstrapFewShot`](https://dspy-docs.vercel.app/docs/deep-dive/teleprompter/bootstrap-fewshot)

* 如果你有稍多一些数据，例如你的任务有 50 个示例，使用 [`BootstrapFewShotWithRandomSearch`](https://dspy-docs.vercel.app/docs/deep-dive/teleprompter/bootstrap-fewshot)。

* 如果你有更多的数据，例如 300 个或更多示例，使用 [`MIPRO`](https://dspy-docs.vercel.app/docs/deep-dive/teleprompter/signature-optimizer)。

* 如果你已经能够使用其中一个大型 LM（例如，7B 参数或更多）并且需要一个非常高效的程序，将其编译为一个小 LM，使用 `BootstrapFinetune`。

## 8) 迭代。

此时，你可能对一切感到非常满意（我们看到很多人第一次尝试就成功了），或者更可能的是，你取得了很大进展，但你不喜欢最终程序或度量标准的某些方面。

此时，回到第 1 步，重新审视主要问题。你是否定义了你的任务？你是否需要收集（或在线查找）更多数据来解决你的问题？你是否想要更新你的度量标准？你是否想要使用更复杂的优化器？你是否需要考虑像 [DSPy 断言](https://dspy-docs.vercel.app/docs/building-blocks/assertions) 这样的高级功能？或者，也许最重要的是，你是否想要在 DSPy 程序本身中添加一些更复杂或更多的步骤？你是否想要在一个序列中使用多个优化器？
迭代式开发至关重要。DSPy为您提供了逐步实现这一目标所需的各个组成部分：可以在数据、程序结构、断言、度量以及优化步骤上进行迭代。

在当前的写作时点，优化复杂的LM程序是一种全新的范式，目前仅在DSPy中存在，因此关于如何操作的规范仍在逐渐形成中。如果您需要帮助，我们最近为社区创建了一个[Discord 服务器](https://discord.gg/VzS6RHHK6F)。